(function(e,t){"function"==typeof define&&define.amd?define(["jquery","underscore","backbone","base"],t):e.Backbone.Fiber=t(e.$,e._,e.Backbone,Base)})(this,function(e,t,n,r){function o(i){var n=e.Deferred();return c[i]?n.resolve(c[i]):(l[i]=n,require([s.viewPath+i,"text!"+s.viewPath+i+".html"],function(e,r){e.prototype.instanceOf=i,e.prototype.template=t.template(r),c[i]=e,delete l[i],n.resolve(e)})),n.promise()}function a(e,i,n){var r,o=new e(t.extend(n,{el:i[0]}));return i.attr("data-cid",o.cid),h[o.cid]=o,r=i.parent().closest("[data-view]"),r.length>0&&(r=r.attr("data-cid"),h[r].addChild(o),o.setParent(h[r])),o.render(),o}function d(t,i){var n=i||{},r=t instanceof e?t:e(t),d=r.attr("data-view");d&&o(d).done(function(e){a(e,r,n)})}n.View.extend=r.extend,n.View.mix=r.mix;var s,c={},h={},l={},u=e.cleanData;return e.cleanData=function(t){for(var i,n=0;void 0!==(i=t[n]);n++)e(i).triggerHandler("destroyed");u(t)},n.Fiber=s={viewPath:"views/",getViewFromEl:function(t){var i=e(t),n=i.attr("data-cid")||i.closest("[data-cid]").attr("data-cid");return n?h[n]:void 0},getViewFromCid:function(e){return h[e]},getElFromCid:function(e){return h[e]?h[e].$el:void 0},getPromise:function(e){return l[e]?l[e]:void 0}},s.start=function(){d(document.body)},n.View.mix([{template:null,parent:null,children:null,renderedOnce:!1,connect:function(t,i){var n,r,o=this,a=e.Deferred();return n="string"==typeof t?this.factory(t):t instanceof e?t:e(t),d(n,i),(r=s.getPromise(n.attr("data-view")))?r.done(function(){a.resolveWith(o,[s.getViewFromEl(n)])}):a.resolveWith(this,[s.getViewFromEl(n)]),a.promise()},waitFor:function(i,n){var r=this,o=t.compact(t.map(i,function(e){return s.getPromise(e)}));e.when.apply(this,o).done(function(){n.apply(r,arguments)})},factory:function(t){return e("<div>").attr("data-view",t).appendTo(this.$el)},initialize:function(){this.$el.on("destroyed",t.bind(this.remove,this)),this.children=[],this.setup(),this.bindData(),this.trigger("created")},bindData:function(){var i=this,n=this.data();n.trigger&&t.each(this.events,function(t,r){var o;(o=r.indexOf(".data"))>-1&&(t=e.isFunction(t)?t:i[t],i.listenTo(n,r.slice(0,o),t))})},setup:e.noop,render:function(){var t,i;this.beforeRender()!==!1&&(this.trigger("rendering"),this.template&&"function"==typeof this.template&&(t=this.dataSerialized(),i=t&&e.isArray(t),(this.renderedOnce&&t||!this.renderedOnce&&(i&&t.length>0||!i))&&(this.$el.empty().html(this.template(t)),this.renderedOnce=!0,this.$el.children().find("[data-view]").each(function(){d(this)}))),this.afterRender(),this.trigger("rendered"))},beforeRender:e.noop,afterRender:e.noop,data:function(){return this.model?this.model:this.collection?this.collection:{}},dataSerialized:function(){var e=this.data();return e.toJSON?e.toJSON():e},remove:function(){this.destroy(),this.parent?h[this.parent].removeChild(this):(this.trigger("removed"),this.stopListening(),delete h[this.cid]),this._superStop()},destroy:e.noop,trigger:function(e,t){this.$el.trigger(e+"."+this.instanceOf,{view:this,data:t||{}})||this._superStop()},setParent:function(e){this.parent=null,e&&(this.parent=e.cid)},addChild:function(e){t.contains(e.cid,this.children)||this.children.push(e.cid)},removeChild:function(e){var i=t.indexOf(this.children,e.cid);i>-1&&(this.children.splice(i,1),e.setParent(null),e.remove())},allChildren:function(){return t.map(this.children,function(e){return s.getViewFromCid(e)})},findChildren:function(e){return t.compact(t.map(this.children,function(){var t;return(t=s.getViewFromCid(this.children[i]))&&t.instanceOf==e?t:void 0}))},findChild:function(t){var i=null;if(t instanceof e)i=s.getViewFromEl(t);else if("string"==typeof t&&(i=s.getViewFromCid(t),!i))for(var n=0;this.children.length>n;n++){var r;(r=s.getViewFromCid(this.children[n]))&&r.instanceOf==t&&(i=r)}return i}}]),s});