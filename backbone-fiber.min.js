(function(t,e){"function"==typeof define&&define.amd?define(["jquery","underscore","backbone","base"],e):t.Backbone.Fiber=e(t.$,t._,t.Backbone,Base)})(this,function(t,e,n,r){function o(i){var n=t.Deferred();return c[i]?n.resolve(c[i]):(l[i]=n,require([s.viewPath+i,"text!"+s.viewPath+i+".html"],function(t,r){t.prototype.instanceOf=i,t.prototype.template=e.template(r),c[i]=t,delete l[i],n.resolve(t)})),n.promise()}function a(t,i,n){var r,o=new t(e.extend(n,{el:i[0]}));return i.attr("data-cid",o.cid),h[o.cid]=o,r=i.parents("[data-view]").first(),r.length>0&&(r=r.attr("data-cid"),h[r].addChild(o),o.setParent(h[r])),o.render(),o}function d(e,i){var n=i||{},r=e instanceof t?e:t(e),d=r.attr("data-view");d&&o(d).done(function(t){a(t,r,n)})}n.View.extend=r.extend,n.View.mix=r.mix;var s,c={},h={},l={},u=t.cleanData;return t.cleanData=function(e){for(var i,n=0;void 0!==(i=e[n]);n++)t(i).triggerHandler("destroyed");u(e)},n.Fiber=s={viewPath:"views/",getViewFromEl:function(e){var i=t(e),n=i.attr("data-cid")||i.closest("[data-cid]").attr("data-cid");return n?h[n]:void 0},getViewFromCid:function(t){return h[t]},getElFromCid:function(t){return h[t]?h[t].$el:void 0},getPromise:function(t){return l[t]?l[t]:void 0}},s.start=function(){d(document.body)},n.View.mix([{template:null,parent:null,children:null,renderedOnce:!1,connect:function(e,i){var n,r,o=this,a=t.Deferred();return n="string"==typeof e?this.factory(e):e instanceof t?e:t(e),d(n,i),(r=s.getPromise(n.attr("data-view")))?r.done(function(){a.resolveWith(o,[s.getViewFromEl(n)])}):a.resolveWith(this,[s.getViewFromEl(n)]),a.promise()},waitFor:function(i,n){var r=this,o=e.compact(e.map(i,function(t){return s.getPromise(t)}));t.when.apply(this,o).done(function(){n.apply(r,arguments)})},factory:function(e){return t("<div>").attr("data-view",e).appendTo(this.$el)},initialize:function(t){this.$el.on("destroyed",e.bind(this.remove,this)),this.options=t||{},this.children=[],this.setup(t),this.bindData(),this.trigger("created")},unbindData:function(){var t=this.data();t.trigger&&this.stopListening(t)},bindData:function(){var i=this,n=this.data();n.trigger&&e.each(this.events,function(e,r){var o;(o=r.indexOf(".data"))>-1&&(e=t.isFunction(e)?e:i[e],i.listenTo(n,r.slice(0,o),e))})},setup:t.noop,render:function(){var e,i;this.beforeRender()!==!1&&(this.trigger("rendering"),this.template&&"function"==typeof this.template&&(e=this.dataSerialized(),i=e&&t.isArray(e),(this.renderedOnce&&e||!this.renderedOnce&&(i&&e.length>0||!i))&&(this.$el.empty().html(this.template(e)),this.renderedOnce=!0,this.$el.find("[data-view]").each(function(){d(this)}))),this.afterRender(),this.trigger("rendered"))},beforeRender:t.noop,afterRender:t.noop,data:function(){return this.model?this.model:this.collection?this.collection:{}},setData:function(t){var e=null;return this.unbindData(),t.model?this.model=e=t.model:t.collection&&(this.collection=e=t.collection),this.bindData(),e&&e.trigger&&e.trigger("ready",e),this},dataSerialized:function(){var t=this.data();return t.toJSON?t.toJSON({computedFields:!0}):t},remove:function(){this.parent?h[this.parent].removeChild(this):(this.destroy(),this.trigger("removed"),this.stopListening(),this.$el.off("destroyed"),this.$el.remove(),delete h[this.cid]),this._superStop()},destroy:t.noop,trigger:function(t,e){this.$el.trigger(t,{view:this,data:e||{}})||this._superStop()},setParent:function(t){this.parent=null,t&&(this.parent=t.cid)},addChild:function(t){e.contains(t.cid,this.children)||this.children.push(t.cid)},removeChild:function(t){var i=e.indexOf(this.children,t.cid);i>-1&&(this.children.splice(i,1),t.setParent(null),t.remove())},allChildren:function(){return e.map(this.children,function(t){return s.getViewFromCid(t)})},findChildren:function(t){return e.compact(e.map(this.children,function(){var e;return(e=s.getViewFromCid(this.children[i]))&&e.instanceOf==t?e:void 0}))},findChild:function(e){var i=null;if(e instanceof t)i=s.getViewFromEl(e);else if("string"==typeof e&&(i=s.getViewFromCid(e),!i))for(var n=0;this.children.length>n;n++){var r;(r=s.getViewFromCid(this.children[n]))&&r.instanceOf==e&&(i=r)}return i}}]),s});