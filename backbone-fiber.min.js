(function(t,e){"function"==typeof define&&define.amd?define(["jquery","underscore","backbone","base"],e):t.Backbone.Fiber=e(t.$,t._,t.Backbone,Base)})(this,function(t,e,i,n){function r(i){var n=t.Deferred();return s[i]?n.resolve(s[i]):(h[i]=n,require([d.viewPath+i,"text!"+d.viewPath+i+".html"],function(t,r){t.prototype.instanceOf=i,t.prototype.template=e.template(r),s[i]=t,delete h[i],n.resolve(t)})),n.promise()}function a(t,i,n){var r,a=new t(e.extend(n,{el:i[0]})),o=!1;return i.attr("data-cid",a.cid),c[a.cid]=a,r=i.parents("[data-view]").first(),r.length>0&&(r=r.attr("data-cid"),c[r]?(c[r].addChild(a),a.setParent(c[r])):(o=!0,a.remove())),o||a.render(),a}function o(e,i){var n=i||{},o=e instanceof t?e:t(e),d=o.attr("data-view");d&&r(d).done(function(t){a(t,o,n)})}i.View.extend=n.extend,i.View.mix=n.mix;var d,s={},c={},h={},l=t.cleanData;return t.cleanData=function(e){for(var i,n=0;void 0!==(i=e[n]);n++)t(i).triggerHandler("destroyed");l(e)},i.Fiber=d={viewPath:"views/",getViewFromEl:function(e){var i=t(e),n=i.attr("data-cid")||i.closest("[data-cid]").attr("data-cid");return n?c[n]:void 0},getViewFromCid:function(t){return c[t]},getElFromCid:function(t){return c[t]?c[t].$el:void 0},getPromise:function(t){return h[t]?h[t]:void 0}},d.start=function(){o(document.body)},i.View.mix([{template:null,parent:null,children:null,renderedOnce:!1,forceRender:!1,connect:function(e,i){var n,r,a=this,s=t.Deferred();return n="string"==typeof e?this.factory(e):e instanceof t?e:t(e),o(n,i),(r=d.getPromise(n.attr("data-view")))?r.done(function(){s.resolveWith(a,[d.getViewFromEl(n)])}):s.resolveWith(this,[d.getViewFromEl(n)]),s.promise()},waitFor:function(i,n){var r=this,a=e.compact(e.map(i,function(t){return d.getPromise(t)}));t.when.apply(this,a).done(function(){n.apply(r,arguments)})},factory:function(e){return t("<div>").attr("data-view",e).appendTo(this.$el)},initialize:function(t){this.$el.on("destroyed",e.bind(this.remove,this)),this.options=t||{},this.children=[],this.setup(t),this.bindData(),this.trigger("created")},unbindData:function(){var t=this.data();t.trigger&&this.stopListening(t)},bindData:function(){var i=this,n=this.data();n.trigger&&e.each(this.events,function(e,r){var a;(a=r.indexOf(".data"))>-1&&(e=t.isFunction(e)?e:i[e],i.listenTo(n,r.slice(0,a),e))})},setup:t.noop,render:function(){var e,i;this.beforeRender()!==!1&&(this.trigger("rendering"),this.template&&"function"==typeof this.template&&(e=this.dataSerialized(),i=e&&t.isArray(e),((this.forceRender||this.renderedOnce)&&e||!this.renderedOnce&&(i&&e.length>0||!i))&&(this.$el.empty().html(this.template(e)),this.renderedOnce=!0,this.$el.find("[data-view]").each(function(){o(this)}))),this.afterRender(),this.trigger("rendered"))},beforeRender:t.noop,afterRender:t.noop,data:function(){return this.model?this.model:this.collection?this.collection:{}},clearData:function(){var t=this.data();return this.unbindData(),this.model=null,this.collection=null,this.trigger("undata",t),this},setData:function(t){var e=null;return this.unbindData(),t.model?this.model=e=t.model:t.collection&&(this.collection=e=t.collection),this.bindData(),e&&e.trigger&&e.trigger("ready",e,this),this},dataSerialized:function(){var t=this.data();return t.toJSON?t.toJSON({computedFields:!0}):t},remove:function(){this.parent?c[this.parent].removeChild(this):(this.destroy(),this.trigger("removed"),this.stopListening(),this.$el.off("destroyed"),this.$el.remove(),delete c[this.cid]),this._superStop()},destroy:t.noop,trigger:function(t,e){this.$el.trigger(t,{view:this,data:e||{}})||this._superStop()},setParent:function(t){this.parent=null,t&&(this.parent=t.cid)},addChild:function(t){e.contains(t.cid,this.children)||this.children.push(t.cid)},removeChild:function(t){var i=e.indexOf(this.children,t.cid);i>-1&&(this.children.splice(i,1),t.setParent(null),t.remove())},allChildren:function(){return e.map(this.children,function(t){return d.getViewFromCid(t)})},findChildren:function(t){return e.compact(e.map(this.children,function(e){var i;return(i=d.getViewFromCid(e))&&i.instanceOf==t?i:void 0}))},findChild:function(e){var i=null;if(e instanceof t)i=d.getViewFromEl(e);else if("string"==typeof e&&(i=d.getViewFromCid(e),!i))for(var n=0;this.children.length>n;n++){var r;(r=d.getViewFromCid(this.children[n]))&&r.instanceOf==e&&(i=r)}return i},isMyElement:function(e){var i=e instanceof t?e:t(e);return i.parents("[data-view]").first().attr("data-cid")==this.cid}}]),d});